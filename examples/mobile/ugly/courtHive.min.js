"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function updateAppState(){Object.keys(settings).forEach(function(e){var t=document.getElementById(e);t&&(settings[e]=t.checked)}),BrowserStorage.set("CH_AppSettings",JSON.stringify(settings)),BrowserStorage.set("CH_AppState",JSON.stringify(app))}function restoreAppState(){var e=BrowserStorage.get("CH_AppSettings");e&&(settings=JSON.parse(e)),Object.keys(settings).forEach(function(e){var t=document.getElementById(e);t&&(t.checked=settings[e])});var t=BrowserStorage.get("CH_AppState");t&&(app=JSON.parse(t))}function closeModal(e){e?document.getElementById(e).style.display="none":Array.from(document.querySelectorAll(".modal")).forEach(function(e){return e.style.display="none"})}function showModal(e,t){document.getElementById("modaltext").innerHTML=e,t&&document.getElementById("copy2clipboard").setAttribute("data-clipboard-text",t),document.getElementById("modal").style.display="flex"}function showGame(e){showGameFish(e.index)}function showGameFish(e){document.getElementById("gamefish").style.display="flex";var t=groupGames(),n=void 0!=e?t[e]:t[t.length-1],a=n.points[0].tiebreak?["0","1","2","3","4","5","6","7"]:["0","15","30","40","G"];charts.gamefish.options({display:{reverse:env.swap_sides},fish:{gridcells:a,cell_size:20},score:n.score}),charts.gamefish.data(n.points).update(),window.scrollTo(0,0)}function closeGameFish(){document.getElementById("gamefish").style.display="none"}function download(e,t){t=t||"match.json";var n=new Blob([e],{type:"text/plain"}),a=document.createElement("a");a.download=t,a.innerHTML="Download File",null!=window.URL?a.href=window.URL.createObjectURL(n):(a.href=window.URL.createObjectURL(n),a.onclick=destroyClickedElement,a.style.display="none",document.body.appendChild(a)),a.click()}function resetButton(e,t){var n=document.getElementById(e);n&&buttons[e]&&buttons[e].color&&(n.style.backgroundColor="white",n.style.color=buttons[e].color,n.style.borderColor=buttons[e].color)}function resetStyles(){Object.keys(buttons).forEach(function(e){return resetButton(e)})}function resetButtons(){var e=env.swap_sides?1-env.serving:env.serving,t=env.swap_sides?1-env.receiving:env.receiving;Array.from(document.querySelectorAll(".fault")).forEach(function(e){return e.innerHTML="Fault"});var n=".modeaction_player"+e;Array.from(document.querySelectorAll(n)).forEach(function(e){return e.innerHTML="Serve"});var a=".modeerr_player"+e;Array.from(document.querySelectorAll(a)).forEach(function(e){return e.innerHTML="Fault"});var r=".modewin_player"+e;Array.from(document.querySelectorAll(r)).forEach(function(e){return e.innerHTML="Ace"});var i=".modeforce_player"+e;Array.from(document.querySelectorAll(i)).forEach(function(e){return e.innerHTML="Let"});var o=".modeaction_player"+t;Array.from(document.querySelectorAll(o)).forEach(function(e){return e.innerHTML="Return"});var s=".modeerr_player"+t;Array.from(document.querySelectorAll(s)).forEach(function(e){return e.innerHTML="UFE"});var c=".modewin_player"+t;Array.from(document.querySelectorAll(c)).forEach(function(e){return e.innerHTML="Winner"});var l=".modeforce_player"+t;Array.from(document.querySelectorAll(l)).forEach(function(e){return e.innerHTML="Forced"}),Array.from(document.querySelectorAll(".vs_point_button")).forEach(function(e){return e.style.display=settings.point_buttons?"flex":"none"}),Array.from(document.querySelectorAll(".rally")).forEach(function(e){return e.innerHTML="Rally"})}function styleButton(e){var t=document.getElementById(e);t&&("flash"==buttons[e].type?(t.style.backgroundColor=buttons[e].color,t.style.color="white",setTimeout(function(){return resetStyles()},300)):"toggle"==buttons[e].type&&("white"==t.style.backgroundColor?(env.serve2nd="second_serve"==e,t.style.backgroundColor=buttons[e].color,t.style.color="white"):(env.serve2nd=!1,t.style.backgroundColor="white",t.style.color=buttons[e].color),toggle_ids.filter(function(t){return t!=e}).forEach(function(e){return resetButton(e)})))}function updateScore(){var e=match.score(),t=e.counters.sets,n=e.counters.games,a=e.points.split("-"),r=env.swap_sides?1:0,i=env.swap_sides?0:1;Array.from(document.getElementsByClassName("points")).forEach(function(e,t){e.value=a[env.swap_sides?1-t:t]});Array.from(document.querySelectorAll(".display_points_0")).forEach(function(e){return e.innerHTML=a[r]});Array.from(document.querySelectorAll(".display_points_1")).forEach(function(e){return e.innerHTML=a[i]});Array.from(document.querySelectorAll(".display_games_0")).forEach(function(e){return e.innerHTML=n[r]});Array.from(document.querySelectorAll(".display_games_1")).forEach(function(e){return e.innerHTML=n[i]});Array.from(document.querySelectorAll(".display_sets_0")).forEach(function(e){return e.innerHTML=t[r]});Array.from(document.querySelectorAll(".display_sets_1")).forEach(function(e){return e.innerHTML=t[i]});var o=e.components.sets,s=match.format.threshold(),c=1==s?0:s>2?4:2;[0,1,2,3,4].forEach(function(e,t){if(!o||o&&!o[t]){Array.from(document.getElementsByClassName("games"+t)).forEach(function(e){return e.value="-"});Array.from(document.getElementsByClassName("display_set_"+t+"_games_0")).forEach(function(e){return e.innerHTML=t>c?" ":"-"});Array.from(document.getElementsByClassName("display_set_"+t+"_games_1")).forEach(function(e){return e.innerHTML=t>c?" ":"-"})}}),o&&o.forEach(function(e,t){Array.from(document.getElementsByClassName("games"+t)).forEach(function(t,n){return t.value=e.games[env.swap_sides?1-n:n]});Array.from(document.getElementsByClassName("display_set_"+t+"_games_0")).forEach(function(t){return t.innerHTML=e.games[env.swap_sides?1:0]});Array.from(document.getElementsByClassName("display_set_"+t+"_games_1")).forEach(function(t){return t.innerHTML=e.games[env.swap_sides?0:1]})})}function swapSides(e){return![!0].concat([].concat(_toConsumableArray(Array(e).keys())).map(function(e){return(e+1)%4<2}))[e]}function swapServer(){if(env.serving=match.nextTeamServing(),env.receiving=match.nextTeamReceiving(),settings.auto_swap_sides){var e=groupGames(),t=e.length;e[e.length-1].complete&&(t+=1),env.match_swap=swapSides(t)}else env.match_swap=!1;setCourtSide();var n=env.swap_sides?1-env.serving:env.serving,a=env.swap_sides?1-env.receiving:env.receiving;document.getElementById(n?"player_receiving":"player_serving");document.getElementById(n?"player_serving":"player_receiving"),changeTextColor(".indicate_serve.display_player_"+n,"yellow"),changeTextColor(".indicate_serve.display_player_"+a,"white"),n?(changeClassDisplay(".display_0_serving","none"),changeClassDisplay(".display_1_serving","flex")):(changeClassDisplay(".display_0_serving","flex"),changeClassDisplay(".display_1_serving","none"));Array.from(document.getElementsByClassName("points")).forEach(function(e,t){var n=env.swap_sides?1-t:t;e.style.backgroundColor=n==env.serving?"#FBF781":"#D1FBFB"}),resetButtons()}function updateState(){match.nextTeamServing()!=env.serving&&setTimeout(function(){return swapServer()},400),resetButtons(),updatePositions()}function visibleButtons(){var e=match.history.action("addPoint"),t=JSON.parse(BrowserStorage.get("match_archive")||"[]");Array.from(document.querySelectorAll(".view_stats")).forEach(function(t){return t.style.display=e.length>0?"inline":"none"}),Array.from(document.querySelectorAll(".change_server")).forEach(function(t){return t.style.display=0==e.length?"inline":"none"}),Array.from(document.querySelectorAll(".view_archive")).forEach(function(n){return n.style.display=0==e.length&&t.length?"inline":"none"}),Array.from(document.querySelectorAll(".view_settings")).forEach(function(n){return n.style.display=0!=e.length||t.length?"none":"inline"}),Array.from(document.querySelectorAll(".view_history")).forEach(function(t){return t.style.display=e.length>0?"inline":"none"}),Array.from(document.querySelectorAll(".undo")).forEach(function(t){t.style.display=e.length>0||env.serve2nd||env.rally_mode?"flex":"none"}),Array.from(document.querySelectorAll(".redo")).forEach(function(e){e.style.display=env.undone.length?"flex":"none"});var n=e.length?e[e.length-1]:void 0,a=function(){if(n){if(n.needed.points_to_set&&1==Math.min.apply(Math,_toConsumableArray(n.needed.points_to_set)))return"SET POINT";if(n.point.breakpoint)return"BREAK POINT";if(n.needed.points_to_game&&1==n.needed.points_to_game[n.point.server])return"GAME POINT"}return env.lets?"Lets: "+env.lets:""}();match.status=a,Array.from(document.querySelectorAll(".status_message")).forEach(function(e){return e.innerHTML=a})}function stateChangeEvent(){updateMatchArchive(),env.serve2nd=!1,env.rally_mode=!1,updateState(),updateScore(),visibleButtons()}function resetEvent(){match.set.perspectiveScore(!1),match.set.liveStats(!0),match.metadata.timestamps(!0),match.metadata.defineMatch({date:null}),env.serve2nd=!1,env.rally_mode=!1,env.serving=match.nextTeamServing(),env.receiving=match.nextTeamReceiving(),env.undone=[],env.rally=0,env.lets=0,resetStyles(),updatePositions(),swapServer(),stateChangeEvent()}function firstAndLast(e){var t=e.split(" "),n=t[0];return t.length>1&&(n+=" "+t[t.length-1]),n}function modalExport(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:BrowserStorage.get("current_match");arguments.length>1&&void 0!==arguments[1]&&arguments[1];Array.from(document.querySelectorAll(".mh_export")).forEach(function(e){return e.style.display="none"});var t=BrowserStorage.get(e),n="\n         <div onclick=\"exportMatch('"+e+"')\" class=\"flexcenter\">\n            <div class='export_action action_icon iconsave'></div>\n         </div>\n      ";showModal('<div>\n         <p>&nbsp;</p>\n         <h1>Export Options</h1>\n         <p>Supported by your device</p>\n      <div class="flexrows flexcenter">'+(device.isIDevice?"":n)+'\n         <div class="flexcenter">\n            <button id=\'copy2clipboard\' class="flexcenter c2c" data-clipboard-text=""> \n               <div class=\'export_action action_icon iconclipboard\'></div> \n            </button>\n         </div> \n      </div></div>',t)}function displayPointHistory(){var e=groupGames(),t=match.metadata.players(),n="";if(!e.length)return!1;e.forEach(function(e,a){e.points&&e.points.length&&(n+=gameEntry(e,t,a))}),n+="\n         <div class=\"flexrows ph_game\">\n            <div class='ph_margin' style='width: 100%'>\n               <div class='flexcenter' style='width: 100%'>Duration "+matchDuration()+"</div>\n            </div>\n         </div>\n      ",document.getElementById("ph_frame").innerHTML=n}function matchDuration(){var e=match.history.points().map(function(e){return e.uts}),t=Math.min.apply(Math,_toConsumableArray(e));return HHMMSS((Math.max.apply(Math,_toConsumableArray(e))-t)/1e3)}function HHMMSS(e){var t=parseInt(e,10),n=Math.floor(t/3600),a=Math.floor((t-3600*n)/60),r=t-3600*n-60*a;return n<10&&(n="0"+n),a<10&&(a="0"+a),r<10&&(r="0"+r),n+":"+a+":"+r}function gameEntry(e,t,n){var a=e.points[e.points.length-1],r=e.complete?e.score.join("-"):void 0,i=a.tiebreak,o=i?"Tiebreak":t[a.server].name,s=i?"":a.server?"playertwo":"playerone",c=i?"":a.server==a.winner?"won":"lost",l='\n         <div class="flexrows ph_game" onclick="showGameFish('+e.index+")\">\n            <div class='ph_margin flexrows'>\n               <div class=\"ph_server "+s+'">'+o+"</div>\n               <div class=\"ph_action flexcenter\"> \n                  <div class='ph_fish iconfish'></div>\n               </div>\n               <div class='ph_rally ph_"+c+"''> <b>"+(r||"")+"</b> </div>\n            </div>\n         </div>\n      ";return e.points.forEach(function(n,a){l+=pointEntry(n,t,e.complete&&a==e.points.length-1?e.score.join("-"):void 0)}),l}function pointEntry(e,t,n){var a,r=e.index%2?"even":"odd",i=!e.tiebreak&&e.server?e.score.split("-").reverse().join("-"):e.score;if(e.result){a=(["Ace","Winner"].indexOf(e.result)>=0?t[e.winner].name:t[1-e.winner].name).split(" ").map(function(e){return e[0]}).join("")}var o=e.hand?e.hand+" ":"",s=e.result||"",c=s?a+": "+o+s:"";i="0-0"==i?"GAME":i,e.tiebreak&&(e.server&&(i="&nbsp;"+i+"*"),e.server||(i="*"+i+"&nbsp;"));var l=e.rally?e.rally.length+1:"";return"\n      <div class='flexrows ph_episode' onclick=\"editPoint("+e.index+")\">\n         <div class='ph_point_"+r+" flexrows'>\n            <div class='ph_result'>"+c+"</div>\n            <div class='ph_score'>"+i+" </div>\n            <div class='ph_score'>"+l+"</div>\n         </div>\n      </div>\n      "}function editPoint(e){env.edit_point_index=e;var t=match.history.action("addPoint");env.edit_point=t[e].point,env.edit_point_result=env.edit_point.result;var n=env.edit_point.server?env.edit_point.score.split("-").reverse().join("-"):env.edit_point.score;"0-0"==n&&(n="Gamepoint"),document.getElementById("ep_sgp").innerHTML="Set: "+(env.edit_point.set+1)+", Game: "+(env.edit_point.game+1)+", Point: "+n;var a=match.metadata.players();Array.from(document.querySelectorAll(".select_player")).forEach(function(e){return a.forEach(function(t,n){return e.options[n]=new Option(t.name,n)})}),document.getElementById("point_winner").value=env.edit_point.winner,document.getElementById("point_result").value=env.edit_point.result||"",changePointWinner(),changeResultOptions(),document.getElementById("editpoint").style.display="flex"}function updatePoint(){var e=document.getElementById("point_winner").value,t=document.getElementById("point_result").value;env.edit_point.winner=e,env.edit_point.result=t,env.edit_point.code=void 0,stateChangeEvent();loadMatch(BrowserStorage.get("current_match"),"pointhistory"),document.getElementById("editpoint").style.display="none"}function changeResultOptions(){var e,t,n=document.getElementById("point_player").value,a=document.getElementById("point_result");env.edit_point_result=a.value,a.innerHTML="",a.options[0]=new Option("- select -","");var r=[];n==env.edit_point.server&&(r=(e=[]).concat.apply(e,_toConsumableArray(r).concat(["Ace","Double Fault"]))),(r=(t=[]).concat.apply(t,_toConsumableArray(r).concat(["Winner","Unforced Error","Forced Error"]))).forEach(function(e,t){return a.options[t+1]=new Option(e,e)}),a.value=env.edit_point_result}function changePointPlayer(){var e=document.getElementById("point_player").value,t=document.getElementById("point_result").value;env.edit_point.result=t;var n=document.getElementById("point_winner").value;(t.indexOf("Winner")>=0||t.indexOf("Ace")>=0)&&e!=n&&(document.getElementById("point_winner").value=e),t.indexOf("Winner")<0&&t.indexOf("Ace")<0&&e==n&&(document.getElementById("point_winner").value=1-e),changeResultOptions()}function changePointWinner(){var e=document.getElementById("point_player").value,t=document.getElementById("point_result").value,n=document.getElementById("point_winner").value;t.indexOf("Winner")<0&&t.indexOf("Ace")<0&&e==n&&(document.getElementById("point_player").value=1-n),(t.indexOf("Winner")>=0||t.indexOf("Ace")>=0)&&e!=n&&(document.getElementById("point_player").value=n)}function resetMatch(e){match.reset(),loadDetails(),updateScore();var t=(new Date).valueOf();e=e||UUID.generate(),match.metadata.defineMatch({muid:e,date:t}),BrowserStorage.set("current_match",e),stateChangeEvent()}function _newMatch(e){resetMatch(),viewManager(e?"entry":"matchformat")}function displayFormats(){var e=match.format.types(),t="";if(!e.length)return!1;e.forEach(function(e){t+=formatEntry(e)}),document.getElementById("matchformatlist").innerHTML=t}function formatEntry(e){var t=void 0,n=void 0,a=umo.formats().matches[e];t=a.name,n=a.description;return"\n      <div class='flexjustifystart mf_format'>\n         <div class='flexcols' onclick=\"changeFormat('"+e+"')\">\n            <div class='mf_name'> <div><b>"+(t=t||"")+"</b></div> </div>\n            <div class='mf_description'> <div>"+n+"</div> </div>\n         </div>\n      </div>\n      "}function displayMatchArchive(){function e(e,t){for(;e.parentNode;)if((e=e.parentNode).classList&&Array.from(e.classList).indexOf(t)>=0)return e;return null}var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).active,n="<div class='swipe-panel no-top'>",a=JSON.parse(BrowserStorage.get("match_archive")||"[]").filter(function(e,t,n){return n.lastIndexOf(e)==t}).reverse();if(a.length){if(!t){a.forEach(function(e){var t=JSON.parse(BrowserStorage.get(e));t?n+=archiveEntry(e,t):BrowserStorage.remove(e)}),n+="</div>";var r=document.getElementById("matcharchiveList");return r.innerHTML=n,SwipeList.init({container:".swipe-item",buttons:[{width:60,side:"right",class:"img_export swipe_img",image:"./icons/exportwhite.png",image_class:"export_icon"},{width:60,side:"right",class:"img_recycle swipe_img",image:"./icons/recycle.png",image_class:"recycle_icon"}]}),r.addEventListener("click",function(t){var n=e(t.target,"swipe-item"),a=n.getAttribute("muid");if(e(t.target,"mh_match"))return loadMatch(a);(t.target.className.indexOf("img_export")>=0||"export_icon"==t.target.className)&&(n.classList.remove("move-out-click"),n.style.webkitTransitionDuration="125ms",n.style.transitionDuration="125ms",n.style.webkitTransform="translateX(0px)",n.style.transform="translateX(0px)",modalExport(a)),(t.target.className.indexOf("img_recycle")>=0||"recycle_icon"==t.target.className)&&(deleteMatch(a),n.remove())}),a}}else _newMatch()}function archiveEntry(e,t){var n=new Date(t.match.date),a=[n.getDate(),months[n.getMonth()],n.getFullYear()].join("-"),r=t.players,i="\n         <span class='nowrap'>"+firstAndLast(r[0].name)+"</span>\n         <span> v. </span>\n         <span class='nowrap'>"+firstAndLast(r[1].name)+"</span>\n         ",o=t.scoreboard;return"\n      <div id='match_"+e+"' muid='"+e+"' class='flexcenter mh_swipe swipe-item'>\n         <div class='flexcols mh_match'>\n            <div class='mh_players'>"+i+"</div>\n            <div class='mh_details'>\n               <div>"+a+"</div>\n               <div class='mh_format'>"+t.format.name+"</div>\n            </div>\n            <div class='mh_score'>"+o+"</div>\n         </div>\n      </div>"}function changeFormat(e){match.format.type(e);var t=match.format.settings().name;document.getElementById("md_format").innerHTML=t,updateScore(),updateMatchArchive(),viewManager("entry")}function loadDetails(){match.metadata.players().forEach(function(e,t){["hand","entry","seed","draw_position","ioc","rank"].forEach(function(n){var a="player"+t+"_"+n,r=document.getElementById(a);r&&(r.value=e[n]||"")})});var e=match.metadata.defineMatch();["court","umpire"].forEach(function(t){var n="match_"+t;document.getElementById(n).value=e[t]||""});var t=match.metadata.defineTournament();["name","start_date","tour","rank","surface","in_out","draw","draw_size","round"].forEach(function(e){var n="tournament_"+e;document.getElementById(n).value=t[e]||""})}function updatePlayer(){match.metadata.definePlayer(updatePlayerDetails(env.edit_player)),updateMatchArchive()}function updatePlayers(){match.metadata.definePlayer(updatePlayerDetails(0)),match.metadata.definePlayer(updatePlayerDetails(1)),updateMatchArchive()}function updatePlayerDetails(){var e={index:env.edit_player};["hand","entry","seed","draw_position","ioc"].forEach(function(t){var n="player_"+t,a=document.getElementById(n);if(a.selectedIndex>=0){var r=a.options[a.selectedIndex].value;r&&(e[t]=r)}});var t=document.getElementById("player_rank").value;return t&&(e.rank=t),e}function updateMatchDetails(){var e={};attributes=["court","umpire"],attributes.forEach(function(t){var n="match_"+t,a=(document.getElementById(n),document.getElementById("match_"+t).value);a&&(e[t]=a)}),match.metadata.defineMatch(e),updateMatchArchive()}function updateTournamentDetails(){var e={},t=["surface","in_out","draw","draw_size","round"];t.forEach(function(t){var n="tournament_"+t,a=document.getElementById(n);if(a.selectedIndex>=0){var r=a.options[a.selectedIndex].value;r&&(e[t]=r)}}),(t=["name","start_date","tour","rank"]).forEach(function(t){var n="tournament_"+t,a=(document.getElementById(n),document.getElementById("tournament_"+t).value);a&&(e[t]=a.trim())}),match.metadata.defineTournament(e),updateMatchArchive()}function loadMatch(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"entry";if(e){match.reset();var n=BrowserStorage.get(e),a=n&&isJSON(n)?JSON.parse(BrowserStorage.get(e)):void 0;a?(clearActionEvents(),BrowserStorage.set("current_match",e),a.match&&(a.match.muid||(a.match.muid=UUID.generate(),BrowserStorage.remove(e)),match.metadata.defineMatch(a.match)),a.first_service&&match.set.firstService(a.first_service),a.tournament&&match.metadata.defineTournament(a.tournament),a.format&&(match.format.settings(a.format),document.getElementById("md_format").innerHTML=a.format.name),a.version||a.points.forEach(function(e){return match.addPoint(e)}),match.metadata.timestamps(!0),a.players&&a.players.forEach(function(e,t){e.index=t,match.metadata.definePlayer(e)}),updatePositions(),updateScore(),loadDetails(),stateChangeEvent(),defineActionEvents(),viewManager(t)):viewManager("entry")}else viewManager("entry")}function loadCurrent(){var e=BrowserStorage.get("current_match");if(e)loadMatch(e),swapServer(),resetButtons(),visibleButtons();else{var t=BrowserStorage.get("match_archive");_newMatch(),t||modalHelp(!0)}}function broadcastStatus(e){if(broadcasting()){var t={muid:match.metadata.defineMatch().muid,status:e},n=match.metadata.defineTournament();t.tuid=n.tuid||n.name,coms.socket.emit("match status",t)}}function deleteMatch(e){if(broadcasting()){var t=JSON.parse(BrowserStorage.get(e)),n={muid:e},a=t&&t.tournament||{};n.tuid=a.tuid||a.name,coms.socket.emit("delete match",n)}BrowserStorage.remove(e);var r=BrowserStorage.get("current_match"),i=JSON.parse(BrowserStorage.get("match_archive")||"[]");i=i.filter(function(t){return e!=t}),BrowserStorage.set("match_archive",JSON.stringify(i)),e==r&&resetMatch(),displayMatchArchive({active:!0})}function exportMatch(e){download(BrowserStorage.get(e),"match_"+e+".json"),closeModal()}function formatChangePossible(){return 0==match.history.points().length}function strokeSlider(e){var t,n=window.innerWidth,a=document.getElementById("stroke_slider");if(e)a.style.display="flex",document.getElementById("slideleft").style.display="right"==e?"flex":"none",document.getElementById("slideright").style.display="left"==e?"flex":"none",a.style.left="left"==e?-1*n+"px":1.5*n+"px",t="left"==e?d3.range(0,1.1,.1):d3.range(0,1.1,.1).reverse(),d3.selectAll(".stroke_slider").data(t).transition().duration(500).style("left",function(e){return e*n*.5+"px"});else{t="left"==("flex"==document.getElementById("slideleft").style.display?"right":"left")?d3.range(-1.5,1.1,.1):d3.range(1,2.6,.1).reverse(),setTimeout(function(){return hideSlide()},700)}d3.selectAll(".stroke_slider").data(t).transition().duration(500).style("left",function(e){return e*n*.5+"px"})}function hideSlide(){document.getElementById("stroke_slider").style.display="none"}function setOrientation(){device.isMobile?env.orientation=90==Math.abs(window.orientation)?"landscape":"portrait":env.orientation=window.innerWidth>window.innerHeight?"landscape":"portrait"}function orientationEvent(){setOrientation(),vizUpdate(),viewManager()}function viewManager(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:env.view,t=arguments[1];strokeSlider();var n={mainmenu:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate,t=void 0===e||e;if(t){touchManager.prevent_touch=!1;var n=JSON.parse(BrowserStorage.get("match_archive")||"[]");document.getElementById("menu_match_archive").style.display=n.length?"flex":"none",document.getElementById("menu_match_format").style.display=formatChangePossible()?"flex":"none";var a=match.history.points();document.getElementById("menu_change_server").style.display=0==a.length?"flex":"none"}changeDisplay(t?"flex":"none","mainmenu")},pointhistory:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate,t=void 0===e||e;t&&(touchManager.prevent_touch=!1,displayPointHistory()),changeDisplay(t?"flex":"none","pointhistory")},matcharchive:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate,t=void 0===e||e;t&&(touchManager.prevent_touch=!1,displayMatchArchive()),changeDisplay(t?"flex":"none","matcharchive")},matchformat:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate,t=void 0===e||e;displayFormats(),t&&(touchManager.prevent_touch=!1),changeDisplay(t?"flex":"none","matchformats")},settings:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate;changeDisplay(void 0===e||e?"flex":"none","settings")},welcome:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate;changeDisplay(void 0===e||e?"flex":"none","welcome")},matchdetails:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate,t=void 0===e||e;t&&(touchManager.prevent_touch=!1),changeDisplay(t?"flex":"none","matchdetails")},entry:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate,t=void 0===e||e;t&&(touchManager.prevent_touch=!0),changeDisplay(t&&"landscape"==env.orientation?"flex":"none",options.horizontal_view),changeDisplay(t&&"portrait"==env.orientation?"flex":"none",options.vertical_view),changeDisplay(t&&"portrait"==env.orientation?"flex":"none","toolbar")},stats:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate,t=void 0===e||e;changeDisplay(t?"flex":"none","statsscreen"),t&&(touchManager.prevent_touch=!1,match.metadata.resetStats(),updateStats())},momentum:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate;if(void 0===e||e){"landscape"==env.orientation?(changeDisplay("none","momentum"),changeDisplay("flex","pts"),charts.pts_match.update()):(changeDisplay("inline","momentum"),changeDisplay("none","pts")),touchManager.prevent_touch=!1;var t=match.history.action("addPoint");charts.mc.width(window.innerWidth).height(820),charts.mc.data(t).update(),charts.mc.update()}else changeDisplay("none","momentum"),changeDisplay("none","pts")},gametree:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).activate,t=void 0===e||e;if(changeDisplay(t?"flex":"none","gametree"),t){touchManager.prevent_touch=!1;var n=match.history.action("addPoint"),a=match.format.settings().code.indexOf("n_")>=0;charts.gametree.options({display:{noAd:a}}),charts.gametree.data(n).update(),charts.gametree.update({sizeToFit:!0})}}},a=Object.keys(n);if(a.indexOf(e)>=0)return a.filter(function(t){return t!=e}).forEach(function(e){return n[e]({activate:!1})}),n[e]({activate:!0,params:t}),env.view=e,e}function toggleChart(e){var t=document.getElementById(e.id+"_chart");if(t){var n="none"!=t.style.display;t.style.display=n?"none":"flex"}}function addCharts(e){var t=match.stats.counters();t&&e.forEach(function(e){var n=[];Object.keys(t.teams).forEach(function(a){var r,i=t.teams[a],o=e.numerators.split(",").map(function(e){return function(e){return e.match(/[A-Za-z0-9]/g).join("")}(e)}),s=(r=[]).concat.apply(r,_toConsumableArray(o.map(function(e){return i[e]}))).map(function(e){return e?e.point:void 0}).filter(function(e){return e}).sort(function(e,t){return e.index-t.index});n.push(s.map(function(e){return e.index}))}),simpleChart(e.target,n)})}function showChartSource(e){console.log(e)}function updateStats(e){var t="",n=[],a=match.sets().length,r="<div class='s_set' onclick=\"updateStats()\">Match</div>",i=match.stats.calculated(e);if(i&&i.length){if(a>1)for(var o=0;o<a;o++)r+="<div class='s_set' onclick=\"updateStats("+o+')">Set '+(o+1)+"</div>";document.querySelector("#statview").innerHTML=r,i.forEach(function(e){var a,r;if(env.swap_sides){var i=_slicedToArray(e.team_stats,2);l=i[0],c=i[1]}else{var o=_slicedToArray(e.team_stats,2);c=o[0],l=o[1]}var s=(a=[]).concat.apply(a,_toConsumableArray([c,l].map(function(e){return e.numerators?e.numerators:[]}))).filter(function(e,t,n){return n.lastIndexOf(e)==t}).join(","),d=(r=[]).concat.apply(r,[0,0].concat(_toConsumableArray([c,l].map(function(e){return e.value?e.value:[]})))).reduce(function(e,t){return e+t}),u=function(e){return e.match(/[A-Za-z0-9_]/g).join("")}(e.name.toLowerCase().split(" ").join("_")),m=c.display,v=l.display,h=s&&d&&"Aggressive Margin"!=e.name?"statname_chart":"statname";isNaN(c.value)&&(c.value=0,m="0"),isNaN(l.value)&&(l.value=0,v="0"),options.highlight_better_stats&&(["Double Faults","Unforced Errors","Forced Errors"].indexOf(e.name)>=0?(c.value<l.value&&(m="<b>"+m+"</b>"),l.value<c.value&&(v="<b>"+v+"</b>")):(c.value>l.value&&(m="<b>"+m+"</b>"),l.value>c.value&&(v="<b>"+v+"</b>"))),t+="<div class='statrow' id=\""+u+'" onClick="toggleChart(this)"><div class=\'statleft\'>'+m+"</div><div class='"+h+"'>"+e.name+"</div><div class='statright'>"+v+"</div></div>";var p="<div class='statrow' id=\""+u+"_chart\" style='display:none' onclick=\"showChartSource('"+s+"')\"></div>";s&&d&&"Aggressive Margin"!=e.name&&(n.push({target:u+"_chart",numerators:s}),t+=p)});var s=match.stats.counters(e).teams;if(s[0].Backhand||s[0].Forehand||s[1].Backhand||s[1].Forehand){var c=env.swap_sides?1:0,l=env.swap_sides?0:1;t+="<div class='statsection flexcenter'>Finishing Shots - Strokes</div>",["Forehand","Backhand"].forEach(function(e){if(s[0][e]||s[1][e]){var n,a=s[c][e]?s[c][e].length:0,r=s[l][e]?s[l][e].length:0;t+="<div class='statrow'><div class='statleft'><b>"+a+"</b></div><div class='statname'><b>Total "+e+" Shots</b></div><div class='statright'><b>"+r+"</b></div></div>";(n=[]).concat.apply(n,_toConsumableArray(Object.keys(s).map(function(t){return s[t][e]?s[t][e].map(function(e){return e.point.result}).filter(function(e){return e}):[]}))).filter(function(e,t,n){return n.lastIndexOf(e)==t}).forEach(function(n){var a,r=s[c][e]?s[c][e].filter(function(e){return e.point.result==n}):[],i=s[l][e]?s[l][e].filter(function(e){return e.point.result==n}):[];(r.length||i.length)&&(t+="<div class='statrow'><div class='statleft'>"+r.length+"</div><div class='statname'>"+e+" "+n+"s</div><div class='statright'>"+i.length+"</div></div>");(a=[]).concat.apply(a,_toConsumableArray(Object.keys(s).map(function(t){return s[t][e]?s[t][e].map(function(e){return e.point.stroke}).filter(function(e){return e}):[]}))).filter(function(e,t,n){return n.lastIndexOf(e)==t}).forEach(function(a){var r=s[c][e]?s[c][e].filter(function(e){return e.point.result==n&&e.point.stroke==a}):[],i=s[l][e]?s[l][e].filter(function(e){return e.point.result==n&&e.point.stroke==a}):[];(r.length||i.length)&&(t+="<div class='statrow'><div class='statleft'>"+r.length+"</div><div class='statname'><i>"+e+" "+a+" "+n+"s</i></div><div class='statright'>"+i.length+"</div></div>")})})}})}document.querySelector("#statlines").innerHTML=t,addCharts(n)}else viewManager("entry")}function changeServer(){match.history.points().length||(match.set.firstService(1-env.serving),updateState())}function changeClassDisplay(e,t){Array.from(document.querySelectorAll(e)).forEach(function(e){return e.style.display=t})}function updatePositions(){var e=env.swap_sides?1:0,t=env.swap_sides?0:1;env.swap_sides,env.serving,env.swap_sides,env.receiving;updateMatchArchive();var n=match.metadata.players();document.getElementById("playerone").innerHTML=firstAndLast(n[e].name),document.getElementById("playertwo").innerHTML=firstAndLast(n[t].name);Array.from(document.querySelectorAll(".display_player_0")).forEach(function(t){return t.innerHTML=n[e].name});Array.from(document.querySelectorAll(".display_player_1")).forEach(function(e){return e.innerHTML=n[t].name})}function defineEntryEvents(){var e=document.getElementById("playername");e.addEventListener("keyup",checkPlayerName,!1),e.addEventListener("keydown",function(e){9==e.which&&e.preventDefault()},!1),e.onblur=function(){changePlayerName()},e.onfocus=function(){var e=this;setTimeout(function(){e.setSelectionRange(0,e.value.length)},300)},document.getElementById("player_rank").onfocus=function(){var e=this;setTimeout(function(){e.setSelectionRange(0,e.value.length)},300)};var t=Array.from(document.querySelectorAll(".pressAndHold"));Array.from(t).forEach(function(e){return touchManager.addPressAndHold(e)})}function editPlayer(e){env.edit_player=env.swap_sides?1-e:e,closeModal(),document.getElementById("editplayer").style.display="flex";var t=match.metadata.players(env.edit_player);document.getElementById("playername").value=t.name;["hand","entry","seed","draw_position","ioc"].forEach(function(e){var n="player_"+e;document.getElementById(n).value=t[e]||""}),document.getElementById("player_rank").value=t.rank||"";var n=e?"editMatchDetails()":"editPlayer("+(env.swap_sides?env.edit_player:1-env.edit_player)+")";d3.select(".ep_next").attr("onclick",n)}function editMatchDetails(){closeModal(),document.getElementById("matchdeets").style.display="flex",document.getElementById("matchdetail_content").scrollTop=0}function checkPlayerName(e){13!=e.keyCode&&9!=e.code||(document.getElementById("player_hand").focus(),changePlayerName())}function changePlayerName(){var e=document.getElementById("playername").value;match.metadata.definePlayer({index:env.edit_player,name:e}),updatePositions()}function changeTextColor(e,t){Array.from(document.querySelectorAll(e)).forEach(function(e){return e.style.color=t})}function classAction(e,t,n,a){function r(e,t){Array.from(document.querySelectorAll(e)).forEach(function(e){return e.innerHTML=t})}function i(){env.rally_mode=!0,Array.from(document.querySelectorAll(".modeforce")).forEach(function(e){return e.style.display="flex"}),r(".vs_action_button.winner","Winner"),r(".vs_action_button.fault","UFE"),r(".vs_action_button.forced","Forced"),Array.from(document.querySelectorAll(".vs_mode_button")).forEach(function(e){["Serve","Return","2nd Serve"].indexOf(e.innerHTML)>=0&&(e.innerHTML="Base Line")})}if(!checkMatchEnd()){var o=n?"right":"left";env.swap_sides&&["server","receiver"].indexOf(n)<0&&(n=1-n),resetStyles();var s={firstServe:function(){env.serve2nd=!1},secondServe:function(){env.serve2nd=!toggles.serve2nd,toggles.serve2nd=!toggles.serve2nd},fault:function(e,t){if(t==env.serving){if(env.serve2nd)return{code:"D"};var n=env.swap_sides?1-t:t;r(".fault.display_"+n+"_serving","Double Fault"),r(".fault.modeerr_player"+n,"Double Fault");var a=".modeaction_player"+(env.swap_sides?1-env.serving:env.serving);Array.from(document.querySelectorAll(a)).forEach(function(e){return e.innerHTML="2nd Serve"}),env.serve2nd=!0,broadcastStatus("Service Fault")}},doubleFault:function(e,t){return t!=env.serving?void 0:{code:"d"}},ace:function(e,t){return t!=env.serving?void 0:env.serve2nd?{code:"a"}:{code:"A"}},winner:function(e,t){return{winner:t,result:"Winner"}},unforced:function(e,t){return{winner:1-t,result:"Unforced Error"}},forced:function(e,t){return{winner:1-t,result:"Forced Error"}},point:function(e,t){return{winner:t}},penalty:function(e,t){return{winner:1-t,result:"Penalty",code:t==env.serving?"P":"Q"}},modewin:function(t,n){var a=e.innerHTML;return"Ace"==a?s.ace(t,n):"Winner"==a?s.winner(t,n):void 0},modeerr:function(t,n){var a=e.innerHTML;return"Fault"==a||"Double Fault"==a?s.fault(t,n):"UFE"==a?s.unforced(t,n):"Forced"==a?s.forced(t,n):"Let"==a?s.let(t,n):void 0},modeaction:function(t,n){var a=e.innerHTML;["Serve","2nd Serve","Return"].indexOf(a)>=0&&i(),"Serve"!=a&&"Return"!=a||i(),"Net"==a&&(e.innerHTML="Base Line"),"Base Line"==a&&(e.innerHTML="Net")},rally:function(){var t=e.innerHTML;env.rally=parseInt((t.match(/\d+/g)||["0"]).join("")),env.rally+=1,r(".rally","Rally: "+env.rally),1==env.rally&&i()},let:function(t,n){broadcastStatus("Service: Let");env.swap_sides,env.serving,e.innerHTML;env.lets+=1}},c=document.getElementById("click");if(settings.audible_clicks&&c.play(),e.id&&styleButton(e.id),a&&"second_service"==a&&(env.serve2nd=!0),!(Object.keys(s).indexOf(t)<0)){var l=["server","receiver"].indexOf(n);l>=0&&(n=l?env.receiving:env.serving);var d=env.serve2nd?{first_serve:{error:"Error",serves:["0e"]}}:{},u=s[t](d,n);if(u){checkStartTime(),Object.assign(d,u),env.rally&&(d.rally=new Array(env.rally));var m=getPointLocation(d);m&&(d.location=m);t=match.addPoint(d);settings.track_shot_types&&t.result&&t.point.result&&["Penalty","Ace","Double Fault"].indexOf(t.point.result)<0?strokeSlider(o):(checkMatchEnd(t),broadcastScore(t)),env.rally=0,env.lets=0,env.undone=[],updateState()}visibleButtons()}}}function broadcastScore(e){e=e||match.history.lastPoint();var t=match.metadata.players();if(t[0].name!=default_players[0]&&t[1].name!=default_players[1]&&broadcasting()){var n=device.geoposition.coords||{},a=match.metadata.defineTournament(),r=match.metadata.defineMatch(),i={tournament:a,match:match.metadata.defineMatch(),event:{euid:r.euid},status:match.status,players:match.metadata.players(),score:match.score(),point:e.point,serving:match.nextTeamServing(),complete:match.complete(),winner:match.winner(),geoposition:{latitude:n.latitude,longitude:n.longitude},undo:"string"==typeof e&&"Undo"==e};dev.match_message=i,sendScoreUpdate(i)}}function sendScoreUpdate(e){var t=Date.now();if(next_update=e,t-last_update>update_window)coms.socket.emit("match score",next_update),last_update=t;else{last_timeout&&clearTimeout(last_timeout);var n=update_window-(t-last_update);last_timeout=setTimeout(function(){coms.socket.emit("match score",next_update),last_update=t},n)}}function distance(e,t,n,a){var r=.017453292519943295,i=Math.cos,o=.5-i((n-e)*r)/2+i(e*r)*i(n*r)*(1-i((a-t)*r))/2;return 12742*Math.asin(Math.sqrt(o))}function checkMatchEnd(e){if(match.complete()){return showModal('<div style="height: 50vh" class="flexcols flexcenter"><div>Match Complete!</div><div>Winner: '+match.metadata.players()[match.winner()].name+"</div></div>"),!0}e&&e.game.complete&&settings.display_gamefish&&showGameFish()}function strokeAction(e,t,n){if(e&&t){var a=match.history.lastPoint();match.decoratePoint(a,{hand:e,stroke:t}),stateChangeEvent()}strokeSlider();var r=match.history.action("addPoint"),i=r[r.length-1];checkMatchEnd(i),broadcastScore(i)}function checkStartTime(){if(0==match.history.points().length){var e=new Date;match.metadata.defineMatch({date:e.valueOf()})}}function getPointLocation(e){var t=document.querySelectorAll(".modeaction_player0"),n=document.querySelectorAll(".modeaction_player1");if(t&&"Net"==t[0].innerHTML||n&&"Net"==n[0].innerHTML)if("Unforced Error"==e.result||"Forced Error"==e.result){if(0==e.winner&&"Net"==n[0].innerHTML)return"Net";if(1==e.winner&&"Net"==t[0].innerHTML)return"Net"}else if("Winner"==e.result){if(0==e.winner&&"Net"==t[0].innerHTML)return"Net";if(1==e.winner&&"Net"==n[0].innerHTML)return"Net"}}function updateMatchArchive(e){var t=match.history.points(),n=BrowserStorage.get("current_match");if(n){var a=match.metadata.players();if(e||t.length||a[0].name!=default_players[0]&&a[1].name!=default_players[1]){var r=JSON.parse(BrowserStorage.get("match_archive")||"[]");r.indexOf(n)<0&&(r.push(n),BrowserStorage.set("match_archive",JSON.stringify(r)));var i={ch_version:ch_version,players:a,first_service:match.set.firstService(),match:match.metadata.defineMatch(),format:match.format.settings(),tournament:match.metadata.defineTournament(),points:t,scoreboard:match.scoreboard()};BrowserStorage.set(n,JSON.stringify(i))}}}function menuAction(e,t){var n={changeServer:function(){match.history.points().length||(match.set.firstService(1-env.serving),updateState(),viewManager("entry"))},undo:function(){if(env.serve2nd||env.rally_mode)env.serve2nd=!1,env.rally_mode=!1,env.rally=0,env.lets=0,resetButtons();else{var e=match.undo();broadcastScore("Undo"),e&&env.undone.push(e),updateMatchArchive(!0)}visibleButtons()},redo:function(){if(env.undone.length){broadcastScore(match.addPoint(env.undone.pop()))}},swap:function(){options.user_swap=!options.user_swap,setCourtSide(),swapServer()},settings:function(){viewManager("settings")},newMatch:function(){_newMatch()},horizontalview:function(){options.horizontal_view="hblack"==options.horizontal_view?"hwhite":"hblack",BrowserStorage.set("horizontal_view",options.horizontal_view),viewManager("entry")},verticalview:function(){}};if(!(Object.keys(n).indexOf(t)<0))n[t]()}function setCourtSide(){env.swap_sides=env.match_swap,options.user_swap&&(env.swap_sides=!env.swap_sides),stateChangeEvent()}function defineActionEvents(){match.events.addPoint(stateChangeEvent),match.events.undo(stateChangeEvent),match.events.reset(resetEvent)}function clearActionEvents(){match.events.clearEvents()}function comsConnect(){}function comsDisconnect(){}function comsError(){}function sendHistory(){var e=match.metadata.defineMatch().muid,t=match.history.points(),n={muid:e,point_history:t};e&&t.length&&coms.socket.emit("point history",n)}function connectSocket(){!navigator.onLine&&"localhost"!=window.location.hostname||coms.socket||(coms.socket=io.connect("/match",coms.connectionOptions),coms.socket.on("connect",comsConnect),coms.socket.on("disconnect",comsDisconnect),coms.socket.on("connect_error",comsError),coms.socket.on("history request",sendHistory),coms.socket.on("tmx error",tmxError),coms.socket.on("tmx directive",tmxDirective),coms.socket.on("tmx message",tmxMessage))}function endBroadcast(){app.broadcast=!1,d3.select("#startpulse").style("display","flex"),d3.select("#pulse").style("display","none").selectAll("svg").remove()}function broadcasting(){return!(!app.broadcast||!coms.socket)||(app.broadcast&&connectSocket(),!1)}function startBroadcast(){connectSocket();var e=pulseCircle().color_range(["white","white"]).height(60).width(60).radius(28).stroke_width(5);d3.select("#startpulse").style("display","none"),d3.select("#pulse").style("display","block").call(e)}function broadcastToggle(){app.broadcast=!app.broadcast,app.broadcast&&coms.socket?startBroadcast():endBroadcast(),navigator.onLine||showModal(" <p> <h1>No Internet Connection!</h1>"),updateAppState()}function checkUserUUID(){app.user_uuid||(app.user_uuid=UUID.generate(),updateAppState())}function init(){changeDisplay("none","welcome");new Clipboard(".c2c").on("success",function(e){closeModal()}),restoreAppState(),checkUserUUID(),connectSocket(),app.broadcast&&navigator.onLine&&startBroadcast(),defineEntryEvents(),defineActionEvents(),touchManager.addSwipeTarget(document.getElementById("mainmenu"));Array.from(document.querySelectorAll(".md_seed")).forEach(function(e){[].concat(_toConsumableArray(Array(32).keys())).forEach(function(t){return e.options[t+1]=new Option(t+1,t+1)})});Array.from(document.querySelectorAll(".md_draw_position")).forEach(function(e){[].concat(_toConsumableArray(Array(128).keys())).forEach(function(t){return e.options[t+1]=new Option(t+1,t+1)})}),d3.json("./assets/ioc_codes.json",function(e){Array.from(document.querySelectorAll(".md_ioc")).forEach(function(t){e.forEach(function(e,n){return t.options[n+1]=new Option(e.name,e.ioc)})}),loadDetails()}),setOrientation(),loadCurrent(),configureViz(),vizUpdate(),queryString.key&&setTimeout(function(){return emitTMX({key:queryString.key})},1e3)}function newGame(){match.history.action("addPoint")[common.pointsAdded.length-1],(e=[]).concat.apply(e,_toConsumableArray(match.score().components.sets.map(function(e){return e.games})));var e,t=match.score().counters.points.reduce(function(e,t){return e+t});Math.floor(t/6)}function groupGames(){var e=[{points:[]}],t=0,n=0;return match.history.action("addPoint").forEach(function(a){var r=a.point;r.game!=n&&(t+=1,n=r.game,e[t]={points:[]}),e[t].points.push(r),e[t].index=t,e[t].set=a.set.index,e[t].score=a.game.games,e[t].complete=a.game.complete,a.game.complete&&(e[t].winner=r.winner),a.set.complete&&(e[t].last_game=!0)}),e}function configureViz(){e=["#a55194","#6b6ecf"];charts.mc=momentumChart(),charts.mc.options({display:{sizeToFit:!1,continuous:!1,orientation:"vertical",transition_time:0,service:!1,rally:!0,player:!1,grid:!1,score:!0},colors:e}),charts.mc.events({score:{click:showGame}}),d3.select("#momentumChart").call(charts.mc);var e={players:["#a55194","#6b6ecf"]};charts.gamefish=gameFish(),charts.gamefish.options({display:{sizeToFit:!0},colors:e}),d3.select("#gameFishChart").call(charts.gamefish),charts.gametree=gameTree();var t={display:{sizeToFit:!0},lines:{points:{winners:"green",errors:"#BA1212",unknown:"#2ed2db"},colors:{underlines:"black"}},nodes:{colors:{0:e.players[0],1:e.players[1],neutral:"#ecf0f1"}},selectors:{enabled:!0,selected:{0:!1,1:!1}}};charts.gametree.options(t),d3.select("#gameTreeChart").call(charts.gametree),charts.pts_match=ptsMatch(),charts.pts_match.options({margins:{top:40,bottom:20},display:{sizeToFit:!0}}),charts.pts_match.data(match),d3.select("#PTSChart").call(charts.pts_match)}function closeViz(){viewManager("entry")}function vizUpdate(){var e="landscape"==env.orientation?"horizontal":"vertical";"pts"==env.view&&"vertical"==e?(changeDisplay("none","pts"),changeDisplay("inline","momentum"),charts.mc.width(window.innerWidth).height(820),charts.mc.update(),env.view="momentum"):"momentum"==env.view&&"horizontal"==e&&(changeDisplay("none","momentum"),changeDisplay("flex","pts"),charts.pts_match.update({sizeToFit:!0}),env.view="pts"),charts.gamefish&&charts.gamefish.update();var t=match.metadata.players();charts.gametree&&(charts.gametree.options({labels:{Player:t[0].name,Opponent:t[1].name}}),charts.gametree.update({sizeToFit:!0}))}function enterKey(e){function t(){n.value&&emitTMX({key:n.value}),closeModal()}showModal("\n         <h2>Enter key:</h2>\n         <input id='key' class='key_input'>\n         <button id='submit_key' class='btn btn-small submit-btn'>Submit</button>\n      ");var n=document.getElementById("key");e&&(n.value=e);document.getElementById("key").addEventListener("keyup",function(e){13==e.which&&t()});document.getElementById("submit_key").addEventListener("click",t)}function emitTMX(e){Object.assign(e,{timestamp:(new Date).getTime(),uuuid:app.user_uuid}),coms.socket.emit("tmx",e)}function tmxError(e){showModal("<h2>"+e.error+"</h2>")}function tmxMessage(e){if(!e||!e.muid){return showModal("<h2>Invalid Key</h2>")}var t=attemptJSONparse(e.data);updateMatchArchive(),resetMatch(t.match.muid),match.metadata.defineTournament({name:t.tournament.name,tuid:t.tournament.tuid,start_date:formatDate(t.tournament.start)}),match.metadata.defineMatch({euid:t.event.euid});var n=t.teams.map(function(e){return e[0].first_name+" "+e[0].last_name});match.metadata.definePlayer({index:0,name:n[0]}),match.metadata.definePlayer({index:1,name:n[1]});var a=t.event.surface;if(a){var r={C:"clay",H:"hard",G:"grass"};r[a]&&match.metadata.defineTournament({surface:r[a]})}var i=t.event.inout;if(i){var o={o:"out",i:"in"};o[i]&&match.metadata.defineTournament({in_out:o[i]})}loadDetails(),stateChangeEvent(),viewManager("entry")}function attemptJSONparse(e){if(e)try{return JSON.parse(e)}catch(e){return}}function tmxDirective(e){console.log("tmx directive",e)}function modalShare(e){broadcastScore();var t=" <p> <h1>First Track a Match!</h1> </p> ",n=(e=e||BrowserStorage.get("current_match"))&&BrowserStorage.get(e);if(n){var a=JSON.parse(n),r=a.match.muid;r||(r=UUID.generate(),a.match.muid=r,match.metadata.defineMatch({muid:r}),BrowserStorage.set(e,JSON.stringify(a))),aip.shareFile(a,"mailcache/ch",r,"ch",function(e){if(JSON.parse(e).error)showModal(t=" <p> <h1>Unable to share match...</h1> <p><i>Connection Error</i></p> </p> ");else{var n=app.broadcast?"CourtHive Live Score: "+location.origin+"/scores?muid="+r:"";showModal(t="\n                  <p>&nbsp;</p>\n                  <h1>Options for Sharing</h1>\n                  <div class='flexrows'> \n                     <div class='flexcenter iconmargin' onclick='closeModal()'>\n                        <a href='mailto:?subject=CourtHive Match Link&body="+n+"%0D%0A ' class=\"notextdecoration\">\n                           <img class=\"icon_large\" src='icons/emailblack.png'>\n                        </a> \n                     </div>\n                     <div class='flexcenter iconmargin'>\n                        <button id='copy2clipboard' class=\"flexcenter c2c\" data-clipboard-text=\"\"> \n                           <div class='export_action action_icon_large iconclipboard'></div> \n                        </button>\n                     </div>\n                  </div> \n               ",n+"\r\n")}})}else showModal(t)}function modalInfo(){showModal('\n         <p>&nbsp;</b>\n         <h2>CourtHive</h2>\n         <p>version <a id="version" target="_blank" href="https://github.com/TennisVisuals/universal-match-object/tree/master/examples/CourtHive">'+ch_version+'</a></p>\n         <p>An \n            <a target="_blank" href="https://github.com/TennisVisuals/universal-match-object/tree/master/examples/CourtHive">Open Source</a> project developed by \n            <a target="_blank" href="http://TennisVisuals.com">TennisVisuals</a>\n         </p>\n         <p><a href="mailto:tennis.aip@gmail.com?subject=CourtHive">Feedback Welcome!</a></p>\n         <h2>Help</h2>\n         <div class="helpitem">Difficulties after an app update?</div>\n         <div class="flexcenter">\n            <div class=\'flexcenter reset\' onclick="appReset()">Reset</div>\n         </div>\n         <p>&nbsp;</b>\n      ')}function lsTest(){try{return localStorage.setItem("test","test"),localStorage.removeItem("test"),!0}catch(e){return!1}}function isJSON(e){try{JSON.parse(e)}catch(e){return!1}return!0}function appReset(){if(lsTest())localStorage.clear();else{BrowserStorage.remove("current_match");var e=BrowserStorage.get("match_archive");if(isJSON(e)){JSON.parse(e).forEach(function(e){return BrowserStorage.remove(e)}),BrowserStorage.remove("match_archive")}}closeModal(),_newMatch()}function formatDate(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"-",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"YMD";if(!e)return"";var a=new Date(e),r=""+(a.getMonth()+1),i=""+a.getDate(),o=a.getFullYear();return r.length<2&&(r="0"+r),i.length<2&&(i="0"+i),"DMY"==n?[i,r,o].join(t):"MDY"==n?[r,i,o].join(t):"YDM"==n?[o,i,r].join(t):"DYM"==n?[i,o,r].join(t):"MYD"==n?[r,o,i].join(t):[o,r,i].join(t)}function modalHelp(e){var t='\n         <div class="helpintro">Quick Start</div>\n         <div class="flexhelp"> <div class=\'iconmenub action_icon_large\'></div> <div class="quicktitle">Main Menu</div> </div>\n         <div class="quickitem"> <span> Set <b>Match Details</b>, <b>Share</b>, or turn on <b>Broadcasting</b> </span></div>\n         <div class="flexhelp"> <div class=\'iconsettingsb action_icon_large\'></div> <div class="quicktitle">Settings</div> </div>\n         <div class="quickitem"> <span> Turn on <b>Audible Clicks</b> and <b>Track Shot Types</b></span></div>\n         <div class="flexhelp"> <div class=\'iconchangeb action_icon_large\'></div> <div class="quicktitle">Change First Server</div> </div>\n         <div class="quickitem"> <span>After Service press <b>Serve</b>, <b>Return</b>, or <b>Rally</b> to switch into Rally Mode </span></div>\n         <div class="quickitem"> <span>To simply advance points, tap the <b>Points</b> display </span></div>\n         <div class="flexhelp"> <img src=\'icons/points.jpg\'> </div>\n      ',n='\n         <div class="helpintro">Save To Home Screen</div>\n         <div class="helpitem">CourtHive is a Progressive Web App</div>\n         <div class="helpitem"><b>For Full Screen View:</b></div>\n         <div class="helpitem">On iOS use Safari to Save</div>\n         <div class="helpitem">On Android use Chrome</div>\n      ',a='\n         <div class="helpintro">How to</div>\n         <div class="helpitem"><div><b>Add/Change Player Names</b>:</div> &nbsp; <div> Touch the name!</div></div>\n         <div class="helpitem"><div><b>Edit a Point</b>:</div><div> &nbsp; Touch the point in History view</div></div>\n         <div class="helpitem"><div><b>Delete Match</b>:</div><div> &nbsp; Swipe Left in Match Archive </div></div>\n         <div class="helpitem"><div><b>Export Match</b>:</div><div> &nbsp; Swipe Right in Match Archive </div></div>\n         <div class="helpitem"><div><b>Points-to-Set</b>:</div><div> &nbsp; Rotate Momentum Chart</div></div>\n         <div class="helpitem"><div><b>GameTree</b>:</div><div> &nbsp; Tap Player to filter by server</div></div>\n         <div class="flexhelp"> <div class=\'iconbroadcast icon icon_5\'></div> <div class="quicktitle">Enable Broadcast</div> </div>\n         <div class="flexhelp"> <div class=\'iconshare icon icon_3\'></div> <div class="quicktitle">Share (Email, Copy/Paste)</div> </div>\n      ';showModal(e?t+n+a:a+n+t)}var _slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],a=!0,r=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(a=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);a=!0);}catch(e){r=!0,i=e}finally{try{!a&&s.return&&s.return()}finally{if(r)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),match=umo.Match(),ch_version="1.8.2",queryString={};!function(){for(var e=window.location.search.substring(1).split("&"),t=0;t<e.length;t++){var n=e[t].split("=");if(void 0===queryString[n[0]])queryString[n[0]]=n[1];else if("string"==typeof queryString[n[0]]){var a=[queryString[n[0]],n[1]];queryString[n[0]]=a}else queryString[n[0]].push(n[1])}history.pushState("",document.title,window.location.pathname)}();var device={isStandalone:"standalone"in window.navigator&&window.navigator.standalone,isIDevice:/iphone|ipod|ipad/i.test(window.navigator.userAgent),isMobile:void 0!==window.orientation,geoposition:{}},dev={},env={lets:0,rally:0,undone:[],view:"entry",serve2nd:!1,rally_mode:!1,match_swap:!1,swap_sides:!1,orientation:"vertical",serving:match.nextTeamServing(),receiving:match.nextTeamReceiving()},coms={socket:void 0,connectionOptions:{"force new connection":!0,reconnectionDelay:1e3,reconnectionAttempts:"Infinity",timeout:2e4}},app={broadcast:void 0,user_uuid:void 0},settings={track_shot_types:void 0,audible_clicks:void 0,display_gamefish:void 0,auto_swap_sides:void 0},options={user_swap:!1,highlight_better_stats:!0,vertical_view:BrowserStorage.get("vertical_view")||"vblack",horizontal_view:BrowserStorage.get("horizontal_view")||"hblack"},charts={},toggles={},default_players=["Player One","Player Two"],months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],buttons={first_serve:{color:"rgb(64, 168, 75)",type:"toggle"},second_serve:{color:"rgb(255, 116, 51)",type:"toggle"},double_fault:{color:"rgb(221, 56, 48)",type:"flash"},penalty:{color:"rgb(221, 56, 48)",type:"flash"},first_ace:{color:"rgb(64, 168, 75)",type:"flash"},second_ace:{color:"rgb(255, 116, 51)",type:"flash"},server_winner:{color:"rgb(64, 168, 75)",type:"flash"},server_unforced:{color:"rgb(221, 56, 48)",type:"flash"},server_forced:{color:"rgb(255, 116, 51)",type:"flash"},receiving_winner:{color:"rgb(64, 168, 75)",type:"flash"},receiving_unforced:{color:"rgb(221, 56, 48)",type:"flash"},receiving_forced:{color:"rgb(255, 116, 51)",type:"flash"}},toggle_ids=Object.keys(buttons).filter(function(e){return"toggle"==buttons[e].type});navigator.geolocation.getCurrentPosition(function(e){device.geoposition=e}),window.addEventListener("load",function(e){window.applicationCache.addEventListener("updateready",function(e){window.applicationCache.status==window.applicationCache.UPDATEREADY&&confirm("A new version of CourtHive is available. Load it?")&&window.location.reload()},!1)},!1),window.addEventListener("orientationchange",function(){orientationEvent()},!1),window.addEventListener("resize",function(){orientationEvent()},!1),touchManager.disableDrag(),touchManager.swipeLeft=function(e){if(e&&e.id){if("main_menu"==e.id){return void showModal('\n               <div><b>Standalone:</b> <span style="color: blue">'+device.isStandalone+"</span></div>\n               <div><b>Perspective Score:</b> "+match.set.perspectiveScore()+"</div>\n            ")}var t=document.getElementById(e.id+"_delete"),n=document.getElementById(e.id+"_export"),a=t?t.style.display:void 0;"flex"==(n?n.style.display:void 0)?document.getElementById(e.id+"_export").style.display="none":"none"==a&&(document.getElementById(e.id+"_delete").style.display="flex")}},touchManager.swipeRight=function(e){if(e&&e.id){var t=document.getElementById(e.id+"_delete"),n=document.getElementById(e.id+"_export"),a=t?t.style.display:void 0,r=n?n.style.display:void 0;"flex"==a?document.getElementById(e.id+"_delete").style.display="none":"none"==r&&(document.getElementById(e.id+"_export").style.display="flex")}},touchManager.pressAndHold=function(e){e.classList.contains("rally")&&console.log("Prompt for Rally Length")};var next_update,last_timeout,changeDisplay=function(e,t){var n=document.getElementById(t);n&&(n.style.display=e)},last_update=0,update_window=1e4,timer=function(){var e,t,n=1,a=0;return{start:function(t,a){t>=0&&(n=t),a&&(e=document.getElementById(a)),timer.run()},run:function(){t&&clearInterval(t),e&&(e.innerHTML=a),n&&(t=setTimeout(timer.run,1e3/n)),++a},setSpeed:function(e){n=+e,timer.run()}}}();